<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>💖 Time Together - Xác thực 💖</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/config.js"></script>
  <script src="js/loading.js"></script>
  <meta name="theme-color" content="#d66291">
</head>
<body class="login-body">

  <!-- Floating hearts animation -->
  <div class="floating-hearts">
    <div class="heart-float" style="animation-delay: 0s;">💕</div>
    <div class="heart-float" style="animation-delay: 2s;">💖</div>
    <div class="heart-float" style="animation-delay: 4s;">💓</div>
    <div class="heart-float" style="animation-delay: 6s;">💗</div>
    <div class="heart-float" style="animation-delay: 8s;">💝</div>
  </div>
  
  <div id="passcode-screen" class="love-theme">
    <div class="passcode-container">
      <h2 class="passcode-title">💖 Nhập mật khẩu 💖</h2>
      <div class="passcode-dots">
        <span class="dot">♥</span><span class="dot">♥</span><span class="dot">♥</span><span class="dot">♥</span><span class="dot">♥</span><span class="dot">♥</span>
      </div>
      <p class="passcode-status"></p>
      <div class="passcode-keypad">
        <button class="keypad-button" data-key="1">1</button>
        <button class="keypad-button" data-key="2">2</button>
        <button class="keypad-button" data-key="3">3</button>
        <button class="keypad-button" data-key="4">4</button>
        <button class="keypad-button" data-key="5">5</button>
        <button class="keypad-button" data-key="6">6</button>
        <button class="keypad-button" data-key="7">7</button>
        <button class="keypad-button" data-key="8">8</button>
        <button class="keypad-button" data-key="9">9</button>
        <div class="keypad-spacer"></div>
        <button class="keypad-button" data-key="0">0</button>
        <button class="keypad-button keypad-control" data-key="delete"><i class="fas fa-delete-left"></i></button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK for background loading -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    (function() {
      const correctPassword = CONFIG.auth.passcode;
      const authKey = CONFIG.auth.storageKeys.auth;
      const lockoutKey = CONFIG.auth.storageKeys.lockout;
      const attemptsKey = CONFIG.auth.storageKeys.attempts;

      // Initialize Firebase for background loading
      firebase.initializeApp(CONFIG.firebaseLogin);
      const db = firebase.firestore();

      // Load background from database
      const loadBackgroundFromDB = async () => {
        try {
          const bgDoc = await db.collection(CONFIG.collections.background).doc(CONFIG.collections.backgroundMain).get();
          if (bgDoc.exists && bgDoc.data().current) {
            const bgUrl = bgDoc.data().current;
            // Create new image to preload
            const img = new Image();
            return new Promise((resolve, reject) => {
              img.onload = () => {
                document.body.style.backgroundImage = `url('${bgUrl}')`;
                resolve();
              };
              img.onerror = reject;
              img.src = bgUrl;
            });
          } else {
            // No custom background, resolve immediately
            return Promise.resolve();
          }
        } catch (error) {
          console.log('Background loading failed:', error);
          return Promise.reject(error);
        }
      };

      // Show loading screen with minimum duration
      const loadingControl = showLoadingWithMinDuration(CONFIG.app.minLoadingDuration);

      // Load background from database
      loadBackgroundFromDB().then(() => {
        loadingControl.hide();
      }).catch(() => {
        loadingControl.hide();
      });

      if (localStorage.getItem(authKey) === 'true') {
        window.location.href = 'index.html';
        return;
      }

      const dots = document.querySelectorAll('.dot');
      const keypad = document.querySelector('.passcode-keypad');
      const statusEl = document.querySelector('.passcode-status');
      let enteredPasscode = '';

      const updateDots = () => {
        dots.forEach((dot, index) => {
          dot.classList.toggle('filled', index < enteredPasscode.length);
        });
      };

      const resetPasscode = () => {
        enteredPasscode = '';
        updateDots();
      };

      const showPasscodeError = (message) => {
        statusEl.textContent = message;
        const dotsContainer = document.querySelector('.passcode-dots');
        dotsContainer.classList.add('shake');
        setTimeout(() => {
          dotsContainer.classList.remove('shake');
          resetPasscode();
        }, 500);
      };
      
      const handleSuccessfulAuth = () => {
        localStorage.setItem(authKey, 'true');
        sessionStorage.removeItem(lockoutKey);
        sessionStorage.removeItem(attemptsKey);
        window.location.href = 'index.html';
      };

      const handleKeypress = (key) => {
        if (statusEl.textContent) statusEl.textContent = '';

        if (key === 'delete') {
          enteredPasscode = enteredPasscode.slice(0, -1);
        } else if (enteredPasscode.length < 6) {
          enteredPasscode += key;
        }

        updateDots();

        if (enteredPasscode.length === 6) {
          checkPassword();
        }
      };

      const checkPassword = () => {
        if (enteredPasscode === correctPassword) {
          handleSuccessfulAuth();
        } else {
          let failedAttempts = parseInt(sessionStorage.getItem(attemptsKey) || '0') + 1;
          sessionStorage.setItem(attemptsKey, failedAttempts);

          let lockoutDuration = 0;
          const lockoutSettings = CONFIG.auth.lockoutSettings;
          if (failedAttempts >= lockoutSettings.thirdLockout.attempts) {
            lockoutDuration = lockoutSettings.thirdLockout.duration;
          } else if (failedAttempts >= lockoutSettings.secondLockout.attempts) {
            lockoutDuration = lockoutSettings.secondLockout.duration;
          } else if (failedAttempts >= lockoutSettings.firstLockout.attempts) {
            lockoutDuration = lockoutSettings.firstLockout.duration;
          }

          if (lockoutDuration > 0) {
            const lockoutUntil = Date.now() + lockoutDuration * 60 * 1000;
            sessionStorage.setItem(lockoutKey, JSON.stringify({ until: lockoutUntil }));
            showPasscodeError(`Thử lại sau ${lockoutDuration} phút`);
          } else {
            showPasscodeError('Mật khẩu sai');
          }
        }
      };

      const init = () => {
        const lockoutInfo = JSON.parse(sessionStorage.getItem(lockoutKey) || '{}');
        if (lockoutInfo.until && Date.now() < lockoutInfo.until) {
          const minutesLeft = Math.ceil((lockoutInfo.until - Date.now()) / 60000);
          statusEl.textContent = `Thử lại sau ${minutesLeft} phút`;
          keypad.style.display = 'none';
          return;
        }

        keypad.addEventListener('click', (e) => {
          const button = e.target.closest('.keypad-button');
          if (button) {
            const key = button.dataset.key;
            handleKeypress(key);
          }
        });
      };

      init();
    })();
  </script>
</body>
</html>